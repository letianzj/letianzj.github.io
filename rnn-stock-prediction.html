<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 4.2.1">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="google-site-verification" content="bokhEjod5-cme1ZueY6aAPHORfnXv9hSoljSfg2Vp_Q">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"letianzj.github.io","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="Introduction Finanical time series are time stamped sequential data where traditional feed-forward neural network doesn&#39;t handle well. Recurrent neural network (RNN) solves this issue by feeding outp">
<meta property="og:type" content="article">
<meta property="og:title" content="RNN Stock Prediction">
<meta property="og:url" content="https://letianzj.github.io/rnn-stock-prediction.html">
<meta property="og:site_name" content="Systematic Investing">
<meta property="og:description" content="Introduction Finanical time series are time stamped sequential data where traditional feed-forward neural network doesn&#39;t handle well. Recurrent neural network (RNN) solves this issue by feeding outp">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2018-11-25T03:30:00.000Z">
<meta property="article:modified_time" content="2020-07-05T19:46:38.145Z">
<meta property="article:author" content="Letian Wang">
<meta property="article:tag" content="TensorFlow">
<meta property="article:tag" content="Machine Learning">
<meta property="article:tag" content="Deep Learning">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://letianzj.github.io/rnn-stock-prediction.html">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>RNN Stock Prediction | Systematic Investing</title>
  
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-109341958-2"></script>
    <script>
      if (CONFIG.hostname === location.hostname) {
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-109341958-2');
      }
    </script>






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Systematic Investing</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Quant Trading and Portfolio Management</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
        <li class="menu-item menu-item-sitemap">

    <a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="https://letianzj.github.io/rnn-stock-prediction.html">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Letian Wang">
      <meta itemprop="description" content="Letian Wang quantitative trading blog, discuss topics includding trading strategies, portfolio management, risk premia, risk management, systematic trading, and machine learning, deep learning applications in Finance.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Systematic Investing">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          RNN Stock Prediction
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2018-11-24 22:30:00" itemprop="dateCreated datePublished" datetime="2018-11-24T22:30:00-05:00">2018-11-24</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2020-07-05 15:46:38" itemprop="dateModified" datetime="2020-07-05T15:46:38-04:00">2020-07-05</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Machine-Learning/" itemprop="url" rel="index"><span itemprop="name">Machine Learning</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Machine-Learning/Deep-Learning/" itemprop="url" rel="index"><span itemprop="name">Deep Learning</span></a>
                </span>
            </span>

          
  
  <span class="post-meta-item">
    
      <span class="post-meta-item-icon">
        <i class="far fa-comment"></i>
      </span>
      <span class="post-meta-item-text">Disqus: </span>
    
    <a title="disqus" href="/rnn-stock-prediction.html#disqus_thread" itemprop="discussionUrl">
      <span class="post-comments-count disqus-comment-count" data-disqus-identifier="rnn-stock-prediction.html" itemprop="commentCount"></span>
    </a>
  </span>
  
  

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="introduction">Introduction</h2>
<p>Finanical time series are time stamped sequential data where traditional <a href="https://en.wikipedia.org/wiki/Feedforward_neural_network" target="_blank" rel="noopener">feed-forward neural network</a> doesn't handle well. <a href="https://en.wikipedia.org/wiki/Recurrent_neural_network" target="_blank" rel="noopener">Recurrent neural network (RNN)</a> solves this issue by feeding output neurons back into the input to provide memories of previous states. This turns out to be a huge success, especially in Natural Language Processing. Later on, <a href="https://en.wikipedia.org/wiki/Long_short-term_memory" target="_blank" rel="noopener">Long short-term memory (LSTM)</a> and <a href="https://en.wikipedia.org/wiki/Gated_recurrent_unit" target="_blank" rel="noopener">Gated Recurrent Unit(GRU)</a> are designed to alleviate the so-called vanishing/exploding gradients issues in the back-propagation phase of RNNs.</p>
<p>In this post, I will build an RNN model with LSTM or GRU cell to predict the prices of S&amp;P 500. To be specific, a <a href="https://en.wikipedia.org/wiki/Supervised_learning" target="_blank" rel="noopener">supervised machine learning</a> model will be calibrated to predict tomorrow's S&amp;P 500 close price based on the prices from the previous 20 business days. This is a regression problem; yet the codes can be easily adapted to handle classification problem such as simply predicting tomorrow's market direction. The code is located on <a href="https://github.com/letianzj/QuantResearch/tree/master/notebooks" target="_blank" rel="noopener">Github</a>.</p>
<a id="more"></a>
<h2 id="data-processing">Data Processing</h2>
<p>The index data is downloaded from Yahoo Finance. It contains daily Open, High, Low, Close, and Volume information since year 2006. I use three of them, namely High, Low, and Close, believing that <a href="https://en.wikipedia.org/wiki/Average_true_range" target="_blank" rel="noopener">Average True Range</a> containing relevant information about current market conditions. The data is firstly grouped into sliding window of 20 business days, and then splitted 90%/10% into train/test data sets.</p>
<p>An important step in using the stock price data is to normalize the data. Some people use sklearn.preprocessing.MinMaxScaler. To me a natural choice is yesterday's close, which will give us the (intraday high/low) returns seen on newspaper.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">n_window_size = <span class="number">20</span>            <span class="comment"># 20 business days; use first 19 to predict the 20th</span></span><br><span class="line"><span class="comment"># split between train and test, 90%/10%</span></span><br><span class="line">n_total_size = spx_ret.shape[<span class="number">0</span>] - n_window_size + <span class="number">1</span>             <span class="comment"># 3040</span></span><br><span class="line">n_train_set_size = int(np.round(n_total_size*<span class="number">0.9</span>))          <span class="comment"># 2736</span></span><br><span class="line">n_test_set_size = n_total_size - n_train_set_size           <span class="comment"># 304</span></span><br><span class="line"></span><br><span class="line">x_train = np.zeros((n_train_set_size, n_window_size<span class="number">-1</span>, <span class="number">3</span>))          <span class="comment"># shape = (2736, 19, 3)</span></span><br><span class="line">y_train = np.zeros((n_train_set_size, <span class="number">1</span>))                           <span class="comment"># shape = (2736, 1)</span></span><br><span class="line">x_test = np.zeros((n_test_set_size, n_window_size<span class="number">-1</span>, <span class="number">3</span>))            <span class="comment"># shape = (304, 19, 3)</span></span><br><span class="line">y_test = np.zeros((n_test_set_size, <span class="number">1</span>))                             <span class="comment"># shape = (304, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n_train_set_size):</span><br><span class="line">    x_train[i, :, :] = spx_ret.iloc[i:i+n_window_size<span class="number">-1</span>].values</span><br><span class="line">    y_train[i, <span class="number">0</span>] = spx_ret.iloc[i + n_window_size - <span class="number">1</span>, <span class="number">2</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(n_train_set_size, n_total_size):</span><br><span class="line">    x_test[i-n_train_set_size, :, :] = spx_ret.iloc[i:i+n_window_size<span class="number">-1</span>].values</span><br><span class="line">    y_test[i-n_train_set_size, <span class="number">0</span>] = spx_ret.iloc[i + n_window_size - <span class="number">1</span>, <span class="number">2</span>]</span><br></pre></td></tr></table></figure>
<p>To feed batches into tensorflow, it needs a help function called get_next_batch, which I literally adapted from [3].</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># generate next batch; randomly shuffle test set; and then draw without replacement batch_size samples</span></span><br><span class="line"><span class="comment"># after running out of samples, randomly shuffle again</span></span><br><span class="line">index_in_epoch = <span class="number">0</span></span><br><span class="line">perm_array = np.arange(x_train.shape[<span class="number">0</span>])            <span class="comment"># (2736,)</span></span><br><span class="line">np.random.shuffle(perm_array)</span><br><span class="line"></span><br><span class="line"><span class="comment"># function to get the next batch; randomly draw batch_size(50) 20d-windows</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_next_batch</span><span class="params">(batch_size)</span>:</span></span><br><span class="line">    <span class="keyword">global</span> index_in_epoch, x_train, perm_array</span><br><span class="line">    start = index_in_epoch</span><br><span class="line">    index_in_epoch += batch_size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> index_in_epoch &gt; x_train.shape[<span class="number">0</span>]:</span><br><span class="line">        np.random.shuffle(perm_array)  <span class="comment"># shuffle permutation array</span></span><br><span class="line">        start = <span class="number">0</span>  <span class="comment"># start next epoch</span></span><br><span class="line">        index_in_epoch = batch_size</span><br><span class="line"></span><br><span class="line">    end = index_in_epoch</span><br><span class="line">    <span class="keyword">return</span> x_train[perm_array[start:end]], y_train[perm_array[start:end]]</span><br></pre></td></tr></table></figure>
<h2 id="building-graph">Building Graph</h2>
<p>I prefer using <a href="https://www.tensorflow.org/" target="_blank" rel="noopener">tensorflow</a> directly to gain full control over graphs. An alternative is to use Keras [https://en.wikipedia.org/wiki/Keras]. Since we use 19 business days to predict the next business day, the step is 19. Also input is three because every day we use High, Low, and Close prices. Tensorflow already provides layer structure for basic RNN cells, as below.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">n_steps = n_window_size - <span class="number">1</span>                 <span class="comment"># 20 business days, X has 19 days</span></span><br><span class="line">n_inputs = <span class="number">3</span>                                <span class="comment"># HLC</span></span><br><span class="line">n_outputs = <span class="number">1</span>                               <span class="comment"># C(t=20)</span></span><br><span class="line">n_neurons = <span class="number">200</span>                             <span class="comment"># number of neurons in a layer</span></span><br><span class="line">n_layers = <span class="number">2</span>                                <span class="comment"># number of layers</span></span><br><span class="line">learning_rate = <span class="number">0.001</span>                       <span class="comment"># learning rate</span></span><br><span class="line">batch_size = <span class="number">50</span>                             <span class="comment"># batch size</span></span><br><span class="line">n_epochs = <span class="number">100</span>                              <span class="comment"># number of epochs</span></span><br><span class="line"></span><br><span class="line">tf.reset_default_graph()</span><br><span class="line">X = tf.placeholder(tf.float32, [<span class="literal">None</span>, n_steps, n_inputs])                   <span class="comment"># (?, 19, 3)</span></span><br><span class="line">y = tf.placeholder(tf.float32, [<span class="literal">None</span>, n_outputs])                           <span class="comment"># (?, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Bonus: Multi-Layer Perceptron (MLP)</span></span><br><span class="line"><span class="comment"># X_MLP = tf.placeholder(tf.float32, [None, n_steps * n_inputs])              # (?, 57)</span></span><br><span class="line"><span class="comment"># hidden1 = tf.contrib.layers.fully_connected(X_MLP, n_neurons, activation_fn=tf.nn.elu)      # (?, 200)</span></span><br><span class="line"><span class="comment"># hidden2 = tf.contrib.layers.fully_connected(hidden1, n_neurons, activation_fn=tf.nn.elu)      # (?, 200)</span></span><br><span class="line"><span class="comment"># y_pred_MLP = tf.contrib.layers.fully_connected(hidden2, n_outputs, activation_fn=tf.nn.elu)     # (?, 1)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic RNN Cell</span></span><br><span class="line">layers = [tf.contrib.rnn.BasicRNNCell(num_units=n_neurons, activation=tf.nn.elu) <span class="keyword">for</span> layer <span class="keyword">in</span> range(n_layers)]</span><br><span class="line"></span><br><span class="line"><span class="comment"># Basic LSTM Cell</span></span><br><span class="line"><span class="comment"># layers = [tf.nn.rnn_cell.LSTMCell(name='basic_lstm_cell', num_units=n_neurons, activation=tf.nn.elu) for layer in range(n_layers)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># LSTM Cell with peephole connections</span></span><br><span class="line"><span class="comment"># layers = [tf.contrib.rnn.LSTMCell(num_units=n_neurons, activation=tf.nn.leaky_relu, use_peepholes = True) for layer in range(n_layers)]</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GRU cell</span></span><br><span class="line"><span class="comment"># layers = [tf.contrib.rnn.GRUCell(num_units=n_neurons, activation=tf.nn.leaky_relu) for layer in range(n_layers)]</span></span><br><span class="line"></span><br><span class="line">multi_layer_cell = tf.contrib.rnn.MultiRNNCell(layers)</span><br><span class="line"></span><br><span class="line"><span class="comment"># rnn_outputs contains the output tensors for each time step (?, 19, 200)</span></span><br><span class="line"><span class="comment"># states contains the final states of the network, (?, 200)x(2 layers)</span></span><br><span class="line">rnn_outputs, states = tf.nn.dynamic_rnn(multi_layer_cell, X, dtype=tf.float32)</span><br><span class="line"></span><br><span class="line"><span class="comment"># add a densely-connected layer between final state and y</span></span><br><span class="line">y_pred = tf.layers.dense(states[<span class="number">-1</span>], n_outputs)                 <span class="comment"># (?, 1)</span></span><br><span class="line"></span><br><span class="line">loss = tf.reduce_mean(tf.square(y_pred - y))          <span class="comment"># loss function is mean squared error</span></span><br><span class="line">optimizer = tf.train.AdamOptimizer(learning_rate=learning_rate)</span><br><span class="line">training_op = optimizer.minimize(loss)</span><br><span class="line">model_saver = tf.train.Saver()</span><br></pre></td></tr></table></figure>
<h2 id="running-graph">Running Graph</h2>
<p>To run the graph, initiate a tensorflow session and feed in batches. The trained model is also saved for later use.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> tf.Session() <span class="keyword">as</span> sess:</span><br><span class="line">    sess.run(tf.global_variables_initializer())</span><br><span class="line">    <span class="keyword">for</span> epoch <span class="keyword">in</span> range(n_epochs):</span><br><span class="line">        <span class="keyword">for</span> iteration <span class="keyword">in</span> range(n_train_set_size // batch_size):</span><br><span class="line">            x_batch, y_batch = get_next_batch(batch_size) <span class="comment"># fetch the next training batch</span></span><br><span class="line">            <span class="comment">#[a1, a2, a3, a4] = sess.run([rnn_outputs, states, y_pred, training_op], feed_dict=&#123;X: x_batch, y: y_batch&#125;)</span></span><br><span class="line">            sess.run(training_op, feed_dict=&#123;X: x_batch, y: y_batch&#125;)</span><br><span class="line"></span><br><span class="line">        mse_train = loss.eval(feed_dict=&#123;X: x_train, y: y_train&#125;)</span><br><span class="line">        mse_test = loss.eval(feed_dict=&#123;X: x_test, y: y_test&#125;)</span><br><span class="line">        print(epoch, <span class="string">"Train accuracy:"</span>, mse_train, <span class="string">"Test accuracy:"</span>, mse_test)</span><br><span class="line"></span><br><span class="line">    y_train_pred = sess.run(y_pred, feed_dict=&#123;X: x_train&#125;)                 <span class="comment"># (2736, 1)</span></span><br><span class="line">    y_test_pred = sess.run(y_pred, feed_dict=&#123;X: x_test&#125;)                   <span class="comment"># (304, 1)</span></span><br><span class="line">    save_path = model_saver.save(sess, <span class="string">"./rnn_model_final.ckpt"</span>)        <span class="comment"># checkpoint</span></span><br></pre></td></tr></table></figure>
<p>Since we are predicting next day prices, the returns need to be converted back to prices and compare with actual closes.</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">y_train_actual = spx[<span class="string">'Close'</span>].iloc[n_window_size:n_train_set_size+n_window_size]             <span class="comment"># (2736,)</span></span><br><span class="line">y_test_actual = spx[<span class="string">'Close'</span>].iloc[n_train_set_size+n_window_size:]                           <span class="comment"># (304, )</span></span><br><span class="line"></span><br><span class="line">y_train_pred_price = pd.DataFrame(y_train_pred, index=y_train_actual.index)</span><br><span class="line">y_train_pred_price.columns = [<span class="string">'Close'</span>]</span><br><span class="line">y_train_pred_price = spx[[<span class="string">'Close'</span>]].shift(<span class="number">1</span>).iloc[n_window_size:n_train_set_size+n_window_size] * (y_train_pred_price/<span class="number">100.0</span> + <span class="number">1.0</span>)</span><br><span class="line">y_test_pred_price = pd.DataFrame(y_test_pred, index=y_test_actual.index)</span><br><span class="line">y_test_pred_price.columns = [<span class="string">'Close'</span>]</span><br><span class="line">y_test_pred_price = spx[[<span class="string">'Close'</span>]].shift(<span class="number">1</span>).iloc[n_train_set_size+n_window_size:] * (y_test_pred_price/<span class="number">100.0</span> + <span class="number">1.0</span>)</span><br></pre></td></tr></table></figure>
<p>By now the RNN model is trained and ready to predict. The next step would be to put this forecasting signal into backtesting. Stay tuned.</p>
<p><strong>Reference</strong> * Géron, Aurélien. Hands-on machine learning with Scikit-Learn and TensorFlow: concepts, tools, and techniques to build intelligent systems. &quot; O'Reilly Media, Inc.&quot;, 2017. * Lilian Weng, <a href="https://lilianweng.github.io/lil-log/2017/07/08/predict-stock-prices-using-RNN-part-1.html" target="_blank" rel="noopener">Predict Stock Prices Using RNN</a> * Raoul Malm, <a href="https://www.kaggle.com/raoulma/ny-stock-price-prediction-rnn-lstm-gru/notebook" target="_blank" rel="noopener">NY Stock Price Prediction RNN LSTM GRU</a></p>

    </div>

    
    
    
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>Post author:  </strong>Letian Wang
  </li>
  <li class="post-copyright-link">
    <strong>Post link: </strong>
    <a href="https://letianzj.github.io/rnn-stock-prediction.html" title="RNN Stock Prediction">https://letianzj.github.io/rnn-stock-prediction.html</a>
  </li>
  <li class="post-copyright-license">
    <strong>Copyright Notice:  </strong>All articles in this blog are licensed under <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> unless stating additionally.
  </li>
</ul>
</div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Machine-Learning/" rel="tag"># Machine Learning</a>
              <a href="/tags/Deep-Learning/" rel="tag"># Deep Learning</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/hidden-markov-chain.html" rel="prev" title="Hidden Markov Chain">
      <i class="fa fa-chevron-left"></i> Hidden Markov Chain
    </a></div>
      <div class="post-nav-item">
    <a href="/principal-component-analysis.html" rel="next" title="Principal Component Analysis">
      Principal Component Analysis <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    
  <div class="comments">
    <div id="disqus_thread">
      <noscript>Please enable JavaScript to view the comments powered by Disqus.</noscript>
    </div>
  </div>
  

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#introduction"><span class="nav-number">1.</span> <span class="nav-text">Introduction</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#data-processing"><span class="nav-number">2.</span> <span class="nav-text">Data Processing</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#building-graph"><span class="nav-number">3.</span> <span class="nav-text">Building Graph</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#running-graph"><span class="nav-number">4.</span> <span class="nav-text">Running Graph</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Letian Wang"
      src="/images/avatar.gif">
  <p class="site-author-name" itemprop="name">Letian Wang</p>
  <div class="site-description" itemprop="description">Letian Wang quantitative trading blog, discuss topics includding trading strategies, portfolio management, risk premia, risk management, systematic trading, and machine learning, deep learning applications in Finance.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">16</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">11</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/letianzj" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;letianzj" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:letian.zj@gmail.com" title="E-Mail → mailto:letian.zj@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.linkedin.com/in/letian-wang-phd-cfa-frm-75b53312/" title="Linkedin → https:&#x2F;&#x2F;www.linkedin.com&#x2F;in&#x2F;letian-wang-phd-cfa-frm-75b53312&#x2F;" rel="noopener" target="_blank"><i class="fab fa-linkedin fa-fw"></i>Linkedin</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Letian Wang</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<script>
  function loadCount() {
    var d = document, s = d.createElement('script');
    s.src = 'https://https-letianzj-github-io.disqus.com/count.js';
    s.id = 'dsq-count-scr';
    (d.head || d.body).appendChild(s);
  }
  // defer loading until the whole page loading is completed
  window.addEventListener('load', loadCount, false);
</script>
<script>
  var disqus_config = function() {
    this.page.url = "https://letianzj.github.io/rnn-stock-prediction.html";
    this.page.identifier = "rnn-stock-prediction.html";
    this.page.title = "RNN Stock Prediction";
    };
  NexT.utils.loadComments(document.querySelector('#disqus_thread'), () => {
    if (window.DISQUS) {
      DISQUS.reset({
        reload: true,
        config: disqus_config
      });
    } else {
      var d = document, s = d.createElement('script');
      s.src = 'https://https-letianzj-github-io.disqus.com/embed.js';
      s.setAttribute('data-timestamp', '' + +new Date());
      (d.head || d.body).appendChild(s);
    }
  });
</script>

</body>
</html>
